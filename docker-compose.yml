version: '3.9'

services:
  # ==========================
  # Traefik Reverse Proxy
  # ==========================
  traefik:
    image: traefik:v3.0
    container_name: traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080" # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - educloud-net

  # ==========================
  # Microsoft SQL Server
  # ==========================
  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: educloud-mssql
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=YourStrong!Passw0rd
      - MSSQL_PID=Developer
      - MSSQL_MEMORY_LIMIT_MB=2048
    ports:
      - "1433:1433"
    volumes:
      - mssql_data:/var/opt/mssql
    networks:
      - educloud-net
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "YourStrong!Passw0rd" -Q "SELECT 1" -b -o /dev/null
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 10s
    restart: unless-stopped

  # ==========================
  # MongoDB
  # ==========================
  mongo:
    image: mongo:7
    container_name: educloud-mongo
    ports:
      - "27017:27017"
    volumes:
      - ./databases/mongo:/data/db
    networks:
      - educloud-net

  # ==========================
  # Auth Service
  # ==========================
  auth-service:
    build:
      context: ./services/auth-service
    container_name: educloud-auth
    environment:
      APP_NAME: AuthService
      APP_ENV: local
      APP_KEY: base64:SomeRandomKey
      APP_DEBUG: true
      DB_CONNECTION: sqlsrv 
      DB_HOST: mssql
      DB_PORT: 1433
      DB_DATABASE: auth_db
      DB_USERNAME: sa
      DB_PASSWORD: YourStrong!Passw0rd
      DB_TRUST_SERVER_CERTIFICATE: true
      DB_ENCRYPT: no
    depends_on:
      - mssql
    networks:
      - educloud-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.auth.rule=PathPrefix(`/auth`)"
      - "traefik.http.services.auth.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.auth-strip.stripprefix.prefixes=/auth"
      - "traefik.http.routers.auth.middlewares=auth-strip"

  # ==========================
  # Quiz Service
  # ==========================
  quiz-service:
    build:
      context: ./services/quiz-service
    container_name: educloud-quiz
    environment:
      APP_NAME: QuizService
      APP_ENV: local
      APP_KEY: base64:SomeRandomKey
      APP_DEBUG: true
      DB_CONNECTION: sqlsrv 
      DB_HOST: mssql
      DB_PORT: 1433
      DB_DATABASE: quiz_db
      DB_USERNAME: sa
      DB_PASSWORD: YourStrong!Passw0rd
      DB_TRUST_SERVER_CERTIFICATE: true
      DB_ENCRYPT: no
    depends_on:
      - mssql
    networks:
      - educloud-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.quiz.rule=PathPrefix(`/quiz`)"
      - "traefik.http.services.quiz.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.quiz-strip.stripprefix.prefixes=/quiz"
      - "traefik.http.routers.quiz.middlewares=quiz-strip"

  # ==========================
  # Question Bank Service
  # ==========================
  qbank-service:
    build:
      context: ./services/qbank-service
    container_name: educloud-qbank
    environment:
      APP_NAME: QBankService
      APP_ENV: local
      APP_KEY: base64:SomeRandomKey
      APP_DEBUG: true
      DB_CONNECTION: sqlsrv 
      DB_HOST: mssql
      DB_PORT: 1433
      DB_DATABASE: qbank_db
      DB_USERNAME: sa
      DB_PASSWORD: YourStrong!Passw0rd
      DB_TRUST_SERVER_CERTIFICATE: true
      DB_ENCRYPT: no
    depends_on:
      - mssql
    networks:
      - educloud-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.qbank.rule=PathPrefix(`/qbank`)"
      - "traefik.http.services.qbank.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.qbank-strip.stripprefix.prefixes=/qbank"
      - "traefik.http.routers.qbank.middlewares=qbank-strip"

  # ==========================
  # Media Service
  # ==========================
  media-service:
    build:
      context: ./services/media-service
    container_name: educloud-media
    env_file:
      - ./services/media-service/.env
    volumes:
      - ./services/media-service/uploads:/var/www/html/uploads
    networks:
      - educloud-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.media.rule=PathPrefix(`/media`)"
      - "traefik.http.services.media.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.media-strip.stripprefix.prefixes=/media"
      - "traefik.http.routers.media.middlewares=media-strip"

  # ==========================
  # AI Generator Service
  # ==========================
  ai-generator-service:
    build: ./services/ai-generator-service
    container_name: educloud-ai-generator
    environment:
      - APP_NAME=AIQuestionGenerator
      - APP_ENV=local
      - APP_KEY=base64:SomeRandomKey
      - APP_DEBUG=true
    networks:
      - educloud-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ai.rule=PathPrefix(`/ai`)"
      - "traefik.http.services.ai.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.ai-strip.stripprefix.prefixes=/ai"
      - "traefik.http.routers.ai.middlewares=ai-strip"

  # ==========================
  # Frontend
  # ==========================
  frontend:
    build:
      context: ./frontend
    container_name: educloud-frontend
    ports:
      - "8080:8000"
    env_file:
      - ./frontend/.env
    depends_on:
      - auth-service
      - quiz-service
      - qbank-service
    networks:
      - educloud-net
    volumes:
      - ./frontend:/var/www/html
    command: php artisan serve --host=0.0.0.0 --port=8000

  # ==========================
  # Redis
  # ==========================
  redis:
    image: redis:7-alpine
    container_name: educloud-redis
    ports:
      - "6379:6379"
    volumes:
      - ./databases/redis:/data
    networks:
      - educloud-net

  # ==========================
  # Leaderboard Service (MongoDB)
  # ==========================
  leaderboard-service:
    build:
      context: ./services/leaderboard-service
    container_name: educloud-leaderboard
    environment:
      - APP_NAME=LeaderboardService
      - APP_ENV=local
      - APP_DEBUG=true
      - DB_CONNECTION=mongodb
      - DB_HOST=mongo
      - DB_PORT=27017
      - DB_DATABASE=leaderboard_db
    depends_on:
      - mongo
    networks:
      - educloud-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.leaderboard.rule=PathPrefix(`/leaderboard`)"
      - "traefik.http.services.leaderboard.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.leaderboard-strip.stripprefix.prefixes=/leaderboard"
      - "traefik.http.routers.leaderboard.middlewares=leaderboard-strip"

networks:
  educloud-net:
    driver: bridge

volumes:
  mssql_data:
    driver: local