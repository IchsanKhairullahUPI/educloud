version: '3.9'

services:
  # ==========================
  # Microsoft SQL Server
  # ==========================
  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: educloud-mssql
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=YourStrong!Passw0rd
      - MSSQL_PID=Developer
      - MSSQL_MEMORY_LIMIT_MB=2048
    ports:
      - "1433:1433"
    volumes:
      - mssql_data:/var/opt/mssql
    networks:
      - educloud-net
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "YourStrong!Passw0rd" -Q "SELECT 1" -b -o /dev/null
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 10s
    restart: unless-stopped

  # ==========================
  # MongoDB (for analytics or AI data)
  # ==========================
  mongo:
    image: mongo:7
    container_name: educloud-mongo
    ports:
      - "27017:27017"
    volumes:
      - ./databases/mongo:/data/db
    networks:
      - educloud-net

  # ==========================
  # Auth Service
  # ==========================
  auth-service:
    build:
      context: ./services/auth-service
    container_name: educloud-auth
    ports:
      - "8001:8000"
    environment:
      - APP_NAME=AuthService
      - APP_ENV=local
      - APP_KEY=base64:SomeRandomKey
      - APP_DEBUG=true
      - DB_CONNECTION=sqlsrv
      - DB_HOST=mssql
      - DB_PORT=1433
      - DB_DATABASE=auth_db
      - DB_USERNAME=sa
      - DB_PASSWORD=YourStrong!Passw0rd
    depends_on:
      - mssql
    networks:
      - educloud-net

  # ==========================
  # Quiz Service
  # ==========================
  quiz-service:
    build:
      context: ./services/quiz-service
    container_name: educloud-quiz
    ports:
      - "8002:8000"
    environment:
      - APP_NAME=QuizService
      - APP_ENV=local
      - APP_KEY=base64:SomeRandomKey
      - APP_DEBUG=true
      - DB_CONNECTION=sqlsrv
      - DB_HOST=mssql
      - DB_PORT=1433
      - DB_DATABASE=quiz_db
      - DB_USERNAME=sa
      - DB_PASSWORD=YourStrong!Passw0rd
    depends_on:
      - mssql
    networks:
      - educloud-net

  # ==========================
  # Question Bank Service
  # ==========================
  qbank-service:
    build:
      context: ./services/qbank-service
    container_name: educloud-qbank
    ports:
      - "8003:8000"
    environment:
      - APP_NAME=QBankService
      - APP_ENV=local
      - APP_KEY=base64:SomeRandomKey
      - APP_DEBUG=true
      - DB_CONNECTION=sqlsrv
      - DB_HOST=mssql
      - DB_PORT=1433
      - DB_DATABASE=qbank_db
      - DB_USERNAME=sa
      - DB_PASSWORD=YourStrong!Passw0rd
    depends_on:
      - mssql
    networks:
      - educloud-net

  # ==========================
  # Media Service
  # ==========================
  media-service:
    build:
      context: ./services/media-service
    container_name: educloud-media
    ports:
      - "8004:8000"
    env_file:
      - ./services/media-service/.env
    volumes:
      - ./services/media-service/uploads:/var/www/html/uploads
    networks:
      - educloud-net

  # ==========================
  # AI Question Generator Service
  # ==========================
  ai-generator-service:
    build: ./services/ai-generator-service
    container_name: educloud-ai-generator
    ports:
      - "8005:8000"
    environment:
      - APP_NAME=AIQuestionGenerator
      - APP_ENV=local
      - APP_KEY=base64:SomeRandomKey
      - APP_DEBUG=true
    networks:
      - educloud-net

  # ==========================
  # Frontend 
  # ==========================
  frontend:
    build:
      context: ./frontend
    container_name: educloud-frontend
    ports:
      - "8080:8000"
    env_file:
      - ./frontend/.env
    depends_on:
      - auth-service
      - quiz-service
      - qbank-service
    networks:
      - educloud-net
    volumes:
      - ./frontend:/var/www/html
    command: php artisan serve --host=0.0.0.0 --port=8000
    
# ==========================
  # Redis (Cache & Session)
  # ==========================
  redis:
    image: redis:7-alpine
    container_name: educloud-redis
    ports:
      - "6379:6379"
    volumes:
      - ./databases/redis:/data
    networks:
      - educloud-net

# ==========================
  # Leaderboard Service
  # ==========================
  leaderboard-service:
    build:
      context: ./services/leaderboard-service
    container_name: educloud-leaderboard
    ports:
      - "8006:8000" # Asumsi port internal 8000, eksternal 8006
    environment:
      - APP_NAME=LeaderboardService
      - APP_ENV=local
      - APP_DEBUG=true
      - DB_CONNECTION=mongodb
      - DB_HOST=mongo # Nama service MongoDB di docker-compose
      - DB_PORT=27017
      - DB_DATABASE=leaderboard_db
      # Tambahkan env lain yang Anda perlukan
    depends_on:
      - mongo
    networks:
      - educloud-net
      
networks:
  educloud-net:
    driver: bridge
    
volumes:
  mssql_data:
    driver: local
