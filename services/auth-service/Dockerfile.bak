# auth-service/Dockerfile

FROM php:8.3-fpm

# Install required system packages and SQL Server dependencies
# Use explicit, robust steps: install required tools, add MS repository via gpg
# (avoid deprecated `apt-key`), then install ODBC and tools and PHP extensions.
RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
        ca-certificates curl gnupg2 apt-transport-https lsb-release \
        build-essential libpng-dev libonig-dev libxml2-dev zip unzip git \
        unixodbc-dev; \
    # Add Microsoft package signing key and repository (use gpg dearmor, avoid apt-key)
    curl -sSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > /etc/apt/trusted.gpg.d/microsoft.gpg; \
    curl -sSL https://packages.microsoft.com/config/debian/11/prod.list -o /etc/apt/sources.list.d/mssql-release.list; \
    apt-get update; \
    # Install MS ODBC driver and tools (EULA accepted via env var)
    ACCEPT_EULA=Y apt-get install -y --no-install-recommends msodbcsql18 mssql-tools18 unixodbc; \
    # Install PHP PDO and Microsoft drivers via PECL, then enable them
    pecl install sqlsrv-5.11.0 pdo_sqlsrv-5.11.0; \
    docker-php-ext-install pdo; \
    docker-php-ext-enable sqlsrv pdo_sqlsrv; \
    # Verify ODBC installation
    odbcinst -j; \
    cat /etc/odbcinst.ini; \
    rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /var/www

# Copy Laravel project (already has vendor locally)
COPY src/ ./

# Set permissions
RUN chown -R www-data:www-data /var/www

# Expose port (can change if needed)
EXPOSE 8000

# Run Laravelâ€™s built-in server (for development)
CMD ["php", "artisan", "serve", "--host=0.0.0.0", "--port=8000"]
